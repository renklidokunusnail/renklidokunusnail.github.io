<script>
  const csvURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIS8-66VL51XdzL3I0hzPHQ53IuKG-4hIqHOyLUZ3SsgWPjSZcA9r7Uzj9ynf_yl0B1UBPvyF-U9XV/pub?output=csv";
  const postURL = "https://script.google.com/macros/s/AKfycbzFNN4UwBeYaxZIYwqIQmTjiFJOY5DK5-KRjwXIDZtb5_BlN-4lHqvsmZsAdneetwn-SA/exec";
  const baslangicSaat = 10;
  const bitisSaat = 22;
  const saatSelect = document.getElementById("saat");
  const tarihInput = document.getElementById("tarih");
  let alinanSaatler = {};

  async function randevuVerileriniYukle() {
    try {
      const response = await fetch(csvURL);
      const csvText = await response.text();
      const satirlar = csvText.trim().split("\n").slice(1);

      satirlar.forEach(satir => {
        const [tarih, saat] = satir.split(",").map(s => s.trim());
        if (!alinanSaatler[tarih]) alinanSaatler[tarih] = [];
        alinanSaatler[tarih].push(saat);
      });
    } catch (e) {
      console.error("Sheets verisi Ã§ekilemedi:", e);
    }
  }

  function saatleriOlustur(tarih) {
    saatSelect.innerHTML = "";
    const doluSaatler = alinanSaatler[tarih] || [];

    for (let saat = baslangicSaat; saat < bitisSaat; saat += 2) {
      const saatStr = (saat < 10 ? "0" + saat : saat) + ":00";
      const option = document.createElement("option");
      option.value = saatStr;
      option.textContent = saatStr;
      if (doluSaatler.includes(saatStr)) {
        option.disabled = true;
        option.textContent += " (DOLU)";
      }
      saatSelect.appendChild(option);
    }
  }

  tarihInput.addEventListener("change", function () {
    const secilenTarih = this.value;
    saatleriOlustur(secilenTarih);
  });

  document.getElementById("randevuForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const ad = document.getElementById("ad").value.trim();
    const hizmet = document.getElementById("hizmet").value;
    const tarih = tarihInput.value;
    const saat = saatSelect.value;
    const not = document.getElementById("not").value.trim();

    if (!ad || !hizmet || !tarih || !saat) {
      alert("LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.");
      return;
    }

    // Google Sheets'e gÃ¶nder
    const veri = { ad, hizmet, tarih, saat, not };
    try {
      await fetch(postURL, {
        method: "POST",
        body: JSON.stringify(veri),
        headers: { "Content-Type": "application/json" }
      });
    } catch (err) {
      alert("Google Sheets'e kayÄ±t baÅŸarÄ±sÄ±z oldu!");
      console.error(err);
    }

    // WhatsApp yÃ¶nlendirmesi
    const mesaj = Merhaba! Randevu talebi:%0A- Ad Soyad: ${ad}%0A- Hizmet: ${hizmet}%0A- Tarih: ${tarih}%0A- Saat: ${saat}%0A- Not: ${not || "Yok"};
    const whatsappURL = https://wa.me/905551862487?text=${mesaj};
    window.open(whatsappURL, "_blank");

    alert("Randevunuz kaydedildi ve WhatsApp yÃ¶nlendirmesi yapÄ±ldÄ± ðŸŽ‰");
    window.location.reload();
  });

  // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda verileri al ve bugÃ¼nkÃ¼ saatleri gÃ¶ster
  (async () => {
    await randevuVerileriniYukle();
    const bugun = new Date().toISOString().split("T")[0];
    tarihInput.value = bugun;
    saatleriOlustur(bugun);
  })();
</script>
